kind: pipeline
type: docker
name: graboid

steps:
  - name: git-tags
    image: alpine/git
    commands:
      - git fetch --tags

  - name: restore cache
    image: drillster/drone-volume-cache
    privileged: true
    volumes:
      - name: cache
        path: /cache
    settings:
      restore: true
      mount:
        - .coursier/

  - name: compile tests
    image: localhost/estrondo/tremors-build-image:3.2.1-1.7.2
    commands:
      - sbt -Dsbt.coursier.home=.coursier/ graboid/Test/compile

  - name: rebuild cache after compile tests
    image: drillster/drone-volume-cache
    privileged: true
    volumes:
      - name: cache
        path: /cache
    settings:
      rebuild: true
      mount:
        - .coursier/

  - name: execute tests
    image: localhost/estrondo/tremors-build-image:3.2.1-1.7.2
    volumes:
      - name: docker
        path: /var/run/docker.sock
    commands:
      - sbt -Dsbt.coursier.home=.coursier/ graboid/test
    environment:
      DOCKER_HOST: "unix://var/run/docker.run"
      TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE: "/var/run/docker.run"


  - name: stage docker image
    image: localhost/estrondo/tremors-build-image:3.2.1-1.7.2
    commands:
      - sbt -Dsbt.coursier.home=.coursier/ clean graboid/Docker/stage graboid/writeVersionFile

  - name: rebuild cache after stage docker image
    image: drillster/drone-volume-cache
    privileged: true
    volumes:
      - name: cache
        path: /cache
    settings:
      rebuild: true
      mount:
        - .coursier/

  - name: publish docker image
    image: plugins/docker
    volumes:
      - name: docker
        path: /var/run/docker.sock
    settings:
      repo: docker.estrondo.org
      username: tremors-graboid
      dry_run: true
    commands:
      - export PLUGIN_TAGS="$(cat graboid/target/version), latest"
      - cd graboid/target/docker/stage
      - /usr/local/bin/dockerd-entrypoint.sh /bin/drone-docker
volumes:
  - name: docker
    host:
      path: /run/podman/podman.sock
  - name: cache
    host:
      path: /tmp/cache
